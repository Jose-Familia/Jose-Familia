name: Update Wakatime Stats

on:
  schedule:
    - cron: '0 12 * * 0'  # Runs every sunday at 12p.m
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Fetch Wakatime stats
      run: |
        curl -H "Authorization: Bearer ${{ secrets.WAKATIME_API_KEY }}" https://wakatime.com/api/v1/users/current/stats/last_7_days > STATS.json
    - name: Print STATS.json
      run: cat STATS.json
    - name: Generate Markdown stats
      run: |
        echo '## Wakatime Weekly Stats' > STATS.md
        if jq -e '.data.languages' STATS.json > /dev/null; then
          jq -r '.data.languages[] | "| \(.name) | \(.text) | \(.percent)%"' STATS.json >> STATS.md
        else
          echo 'No language data available.' >> STATS.md
        fi
    - name: Update README
      run: |
        # Get the current content for the wakatime stats section
        STATS_CONTENT=$(cat STATS.md)
        # Use awk to replace the wakatime stats section in the README
        awk -v r="$STATS_CONTENT" '/<!-- wakatime-stats-start -->/{print;print r;f=1} /<!-- wakatime-stats-end -->/{f=0} !f' README.md > README.tmp && mv README.tmp README.md
    - name: Commit and push
      uses: EndBug/add-and-commit@v7
      with:
        message: 'Updated Wakatime statistics'
        add: 'README.md'
